<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlow Admin Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéµ</text></svg>">
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
            min-height: 100vh;
            padding: 20px 0;
        }
        .container { 
            max-width: 900px; 
            margin: 40px auto; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(44,62,80,0.15); 
            padding: 0 0 40px 0;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        .header { 
            padding: 40px 32px 20px 32px; 
            text-align: center; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #2c3e50;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 3px solid #667eea;
            border-radius: 16px 16px 0 0;
        }
        .header h1 { 
            margin: 0 0 10px 0; 
            font-size: 2.4em; 
            letter-spacing: 1px;
            text-shadow: none;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p { 
            color: #6c757d; 
            margin: 0;
            font-size: 1.1em;
            text-shadow: none;
        }
        .header .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-top: 15px;
        }
        .header .btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .content { 
            padding: 32px; 
            box-sizing: border-box;
        }
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            padding: 12px 24px; 
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        .btn-success { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #495057; 
            font-weight: 600;
            font-size: 0.95em;
        }
        input[type="text"], input[type="email"], input[type="password"] { 
            width: calc(100% - 32px); 
            padding: 12px 16px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .password-field {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .password-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        .file-input { display: none; }
        .upload-area { 
            border: 3px dashed #667eea; 
            border-radius: 12px; 
            padding: 40px; 
            text-align: center; 
            color: #667eea; 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            cursor: pointer; 
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
        }
        .upload-area.dragover { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #764ba2; 
            color: #764ba2;
            transform: scale(1.02);
        }
        .file-list { margin-bottom: 20px; }
        .file-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px; 
            padding: 15px 20px; 
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .file-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .file-name { font-weight: 600; color: #495057; }
        .file-size { color: #6c757d; font-size: 0.9em; }
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 4px; 
            overflow: hidden; 
            margin-top: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #667eea, #764ba2); 
            width: 0%; 
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        .library-section { margin-top: 40px; }
        .library-section h2 { 
            color: #2c3e50; 
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .song-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-top: 20px;
        }
        .song-card { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .song-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .song-card.expanded {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .song-title { 
            font-weight: 700; 
            color: #2c3e50; 
            font-size: 1.1em;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .song-artist { 
            color: #6c757d; 
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        .song-meta { 
            color: #495057; 
            font-size: 0.85em; 
            line-height: 1.4;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin-top: 0;
        }
        .song-card.expanded .song-meta {
            max-height: 200px;
            opacity: 1;
            margin-top: 12px;
        }
        .song-actions { 
            margin-top: 15px; 
            display: flex; 
            gap: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin-top: 0;
        }
        .song-card.expanded .song-actions {
            max-height: 50px;
            opacity: 1;
            margin-top: 15px;
        }
        .expand-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #6c757d;
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        .song-card.expanded .expand-indicator {
            transform: rotate(180deg);
        }
        .btn-small { 
            padding: 6px 12px; 
            font-size: 12px; 
        }
        .hidden { display: none; }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .stat-number { 
            font-size: 2.2em; 
            font-weight: bold; 
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-label { 
            opacity: 0.9;
            font-weight: 500;
            font-size: 0.95em;
        }
        .logs-btn-section { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 15px; 
        }
        .logs-btn-section .btn { 
            font-size: 0.9em; 
            padding: 6px 14px;
            border-radius: 6px;
        }
        .logs-indicator { 
            color: #6c757d; 
            font-size: 0.9em;
            font-weight: 500;
        }
        .upload-section h2, .cleanup-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.6em;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .cleanup-section {
            margin-top: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .login-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }
        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 400px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .toast.error {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        
        .toast.warning {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }
        
        .toast.info {
            border-left: 4px solid #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        
        .toast-message {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .toast-close:hover {
            background: rgba(0,0,0,0.1);
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ StreamFlow Admin Panel</h1>
            <p id="headerSubtitle">Manage your music library and upload new tracks</p>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary" onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
                <button class="btn btn-secondary" onclick="testApiConnection()" id="debugBtn" style="display: none;">üîç Debug API</button>
                <button class="btn btn-secondary" onclick="testFileUpload()" id="testUploadBtn" style="display: none;">üß™ Test Upload</button>
                <button class="btn btn-secondary" onclick="testUploadButton()" id="testButtonBtn" style="display: none;">üîò Test Button</button>
                <button class="btn btn-secondary" onclick="testAdminUpload()" id="testAdminBtn" style="display: none;">üëë Test Admin Upload</button>
                <button class="btn btn-secondary" onclick="testFilesystemPermissions()" id="testFilesystemBtn" style="display: none;">üíæ Test Filesystem</button>
            </div>
        </div>
        <div class="content">
            <!-- Login Section -->
            <div class="login-section" id="loginSection">
                <h2>üîê Admin Login</h2>
                <div class="form-group">
                    <label for="adminEmail">Email:</label>
                    <input type="email" id="adminEmail" value="admin@streamflow.com" placeholder="Enter admin email">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <div class="password-field">
                        <input type="password" id="adminPassword" value="adminpass123" placeholder="Enter password">
                        <button type="button" class="password-toggle" onclick="togglePassword('adminPassword')" title="Show/Hide Password" aria-label="Toggle password visibility">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn" onclick="login()">Login</button>
                <div id="loginStatus"></div>
            </div>
            <!-- Admin Dashboard (Hidden until login) -->
            <div id="adminDashboard" class="hidden">
                <!-- Stats -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSongs">0</div>
                        <div class="stat-label">Total Songs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPlaylists">0</div>
                        <div class="stat-label">Playlists</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">1</div>
                        <div class="stat-label">Users</div>
                    </div>
                </div>
                <!-- Upload Section -->
                <div class="upload-section">
                    <h2>üìÅ Upload New Music</h2>
                    <div class="upload-area" id="uploadArea">
                        <h3>üéµ Drop audio files here or click to browse</h3>
                        <p>Supports MP3, WAV, FLAC, M4A, OGG files</p>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple accept="audio/*" onchange="handleFileSelect(event)">
                    <div id="fileList" class="file-list"></div>
                    <div class="form-group">
                        <label for="uploadAsTestUser">
                            <input type="checkbox" id="uploadAsTestUser" onchange="updateUploadButtonText()">
                            Upload as Test User (test@streamflow.com)
                        </label>
                        <div id="testUserIndicator" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; color: #856404; font-size: 14px;">
                            ‚ö†Ô∏è Songs will be uploaded to the test user's library
                        </div>
                    </div>
                    <div class="form-group" style="background: #e3f2fd; padding: 12px; border-radius: 6px; border: 1px solid #2196f3; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #1976d2;">
                            <strong>üìù Metadata & Genres:</strong> Songs will use metadata from the audio files for title, artist, and genre. 
                            You can add custom genres during upload if needed.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uploadDestination">Upload Destination:</label>
                        <select id="uploadDestination" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: #f8f9fa;" onchange="updateUploadButtonText()">
                            <option value="library">üìö Upload to Library Only</option>
                            <option value="playlist">üìã Add to Playlist</option>
                        </select>
                    </div>
                    <div class="form-group" id="playlistSelectionGroup" style="display: none;">
                        <label for="playlistSelect">Select Playlist:</label>
                        <select id="playlistSelect" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: #f8f9fa;" onchange="updateUploadButtonText()">
                            <option value="">Loading playlists...</option>
                        </select>
                        <div id="newPlaylistGroup" style="display: none; margin-top: 10px;">
                            <label for="newPlaylistName">New Playlist Name:</label>
                            <input type="text" id="newPlaylistName" placeholder="Enter playlist name..." style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: #f8f9fa;">
                        </div>
                        <div id="selectedPlaylistIndicator" style="display: none; margin-top: 10px; padding: 8px 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; color: #1976d2; font-size: 14px;">
                            <strong>Selected:</strong> <span id="selectedPlaylistName"></span>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshPlaylists()" style="margin-top: 10px;">üîÑ Refresh Playlists</button>
                    </div>
                    <button class="btn btn-success" onclick="uploadFiles()" id="uploadBtn" disabled>Upload All Files</button>
                    <button class="btn btn-secondary" onclick="clearFiles()">Clear Selection</button>
                </div>
                <!-- Library Section -->
                <div class="library-section">
                    <h2>üìö Music Library</h2>
                    <div class="form-group">
                        <input type="text" id="searchLibrary" placeholder="Search songs by title, artist, or album..." onkeyup="searchLibrary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: #f8f9fa; box-sizing: border-box;">
                        <div id="searchStatus" style="margin-top: 8px; font-size: 14px; color: #6c757d;"></div>
                    </div>
                    <div id="libraryGrid" class="song-grid"></div>
                </div>
                <!-- Cleanup Section -->
                <div class="cleanup-section" style="margin-top: 30px; background: #f8f9fa; border-radius: 8px; padding: 25px; border: 1px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üßπ Database & File Cleanup</h2>
                        <div class="logs-btn-section">
                            <span id="loggingIndicator" class="logs-indicator" style="display: none;">üìã Logging Active</span>
                            <button class="btn btn-secondary" onclick="showLogs()" id="logsBtn" style="display: none;">Logs</button>
                        </div>
                    </div>
                    <p style="color: #6c757d; margin-bottom: 20px;">Remove duplicate songs and orphaned files to keep your library clean and organized.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">üîç Duplicate Detection</h4>
                            <p style="margin: 0; font-size: 0.9em; color: #6c757d;">Finds songs with identical titles, artists, and albums</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">üóÇÔ∏è Orphaned Files</h4>
                            <p style="margin: 0; font-size: 0.9em; color: #6c757d;">Removes audio files not linked to any song records</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">üé® Artwork Cleanup</h4>
                            <p style="margin: 0; font-size: 0.9em; color: #6c757d;">Removes artwork files not associated with songs</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="runCleanup('dry-run')" id="dryRunBtn">üîç Dry Run (Preview)</button>
                        <button class="btn btn-danger" onclick="runCleanup('full')" id="fullCleanupBtn">üßπ Full Cleanup</button>
                        <button class="btn" onclick="clearCleanupResults()" id="clearResultsBtn" style="display: none;">Clear Results</button>
                    </div>
                    <div id="cleanupProgress" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">üîÑ Cleanup Progress</h4>
                            <div class="progress-bar" style="margin-bottom: 10px;">
                                <div class="progress-fill" id="cleanupProgressBar" style="width: 0%;"></div>
                            </div>
                            <div id="cleanupStatus" style="font-size: 0.9em; color: #6c757d;">Initializing...</div>
                        </div>
                    </div>
                    <div id="cleanupResults" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin: 0 0 15px 0; color: #495057;">üìä Cleanup Results</h4>
                            <div id="cleanupSummary" style="margin-bottom: 20px;"></div>
                            <div id="cleanupDetails" style="font-size: 0.9em; color: #6c757d;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast-container">
        <!-- Toast notifications will be dynamically added here -->
    </div>
    <script>
        // === Globals & config ===
        // Dynamic API base URL detection for production deployment
        const API_BASE = (() => {
            // Check if we're in production (deployed on Railway)
            const isProduction = window.location.hostname.includes('railway.app') || 
                                window.location.hostname.includes('vercel.app') ||
                                window.location.hostname.includes('netlify.app') ||
                                window.location.hostname.includes('herokuapp.com');
            
            if (isProduction) {
                // In production, use the same domain but with the API path
                const protocol = window.location.protocol;
                const hostname = window.location.hostname;
                const port = window.location.port ? `:${window.location.port}` : '';
                return `${protocol}//${hostname}${port}/api`;
            } else {
                // In development, use localhost
                return 'http://localhost:8000/api';
            }
        })();
        
        console.log('üîç Admin API Base URL:', API_BASE);
        console.log('üîç Current location:', window.location.href);
        console.log('üîç Hostname:', window.location.hostname);
        
        let authToken = localStorage.getItem('streamflow_admin_token');
        let selectedFiles = [];
        let isAuthenticated = false;
        let deletedSongs = []; // Store deleted songs for undo functionality
    
        let loggingConfig = {
          enabled: true,
          maxLogs: 50,
        };
    
        // === Logging helpers ===
        function logToStorage(message, data = null) {
          if (!loggingConfig.enabled) return;
          const timestamp = new Date().toISOString();
          const logEntry = { timestamp, message, data };
          let logs = JSON.parse(localStorage.getItem('streamflow_logs') || '[]');
          logs.push(logEntry);
          if (logs.length > loggingConfig.maxLogs) {
            logs = logs.slice(-loggingConfig.maxLogs);
          }
          localStorage.setItem('streamflow_logs', JSON.stringify(logs));
          console.log(`[${timestamp}] ${message}`, data);
        }
    
        function showLogs() {
          const logs = JSON.parse(localStorage.getItem('streamflow_logs') || '[]');
          const logText = logs
            .map((log) =>
              `[${log.timestamp}] ${log.message}${
                log.data ? ' - ' + JSON.stringify(log.data) : ''
              }`
            )
            .join('\n');
          const popup = window.open('', '_blank', 'width=900,height=700');
          popup.document.write('<!DOCTYPE html><html><head><title>Logs</title>');
          popup.document.write(
            '<style>body{font-family:Arial,sans-serif;margin:20px;}</style>'
          );
          popup.document.write('</head><body>');
          popup.document.write('<pre>' + logText + '</pre>');
          popup.document.write('</body></html>');
        }
    
        function updateLoggingButton() {
          const btn = document.getElementById('logsBtn');
          const indicator = document.getElementById('loggingIndicator');
          if (btn && indicator) {
            btn.style.display = loggingConfig.enabled
              ? 'inline-block'
              : 'none';
            indicator.style.display = loggingConfig.enabled
              ? 'inline'
              : 'none';
          }
        }
    
        // === Debugging & Testing ===
        async function testApiConnection() {
          console.log('üîç Testing API connection...');
          console.log('üîç API Base URL:', API_BASE);
          console.log('üîç Current location:', window.location.href);
          console.log('üîç Hostname:', window.location.hostname);
          console.log('üîç Protocol:', window.location.protocol);
          console.log('üîç Auth token exists:', !!authToken);
          console.log('üîç Auth token length:', authToken ? authToken.length : 0);
          
          const results = [];
          
          try {
            // Test basic connectivity
            console.log('üîç Testing health endpoint...');
            const healthRes = await fetch(`${API_BASE.replace('/api', '')}/health`);
            console.log('üîç Health check:', healthRes.status, healthRes.statusText);
            results.push(`Health: ${healthRes.status} ${healthRes.statusText}`);
            
            // Test auth endpoint
            if (authToken) {
              console.log('üîç Testing auth endpoint...');
              const authRes = await fetch(`${API_BASE}/auth/me`, {
                headers: { Authorization: `Bearer ${authToken}` }
              });
              console.log('üîç Auth test:', authRes.status, authRes.statusText);
              results.push(`Auth: ${authRes.status} ${authRes.statusText}`);
              
              if (authRes.ok) {
                const userData = await authRes.json();
                console.log('üîç User data:', userData);
                results.push(`User: ${userData.username} (${userData.role})`);
              } else {
                const errorText = await authRes.text();
                console.log('üîç Auth error response:', errorText);
                results.push(`Auth Error: ${errorText}`);
              }
            } else {
              results.push('Auth: No token available');
            }
            
            // Test upload endpoint (without actually uploading)
            console.log('üîç Testing upload endpoint...');
            const uploadRes = await fetch(`${API_BASE}/songs/upload`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${authToken}` }
            });
            console.log('üîç Upload endpoint test:', uploadRes.status, uploadRes.statusText);
            
            // Get the actual error response for debugging
            if (!uploadRes.ok) {
              try {
                const errorData = await uploadRes.text();
                console.log('üîç Upload endpoint error response:', errorData);
                results.push(`Upload: ${uploadRes.status} - ${errorData.substring(0, 100)}...`);
              } catch (e) {
                results.push(`Upload: ${uploadRes.status} ${uploadRes.statusText}`);
              }
            } else {
              results.push(`Upload: ${uploadRes.status} ${uploadRes.statusText}`);
            }
            
            // Test CORS by checking if we can make requests
            console.log('üîç Testing CORS...');
            const corsTest = await fetch(`${API_BASE}/songs/`, {
              headers: { Authorization: `Bearer ${authToken}` }
            });
            console.log('üîç CORS test:', corsTest.status, corsTest.statusText);
            results.push(`CORS: ${corsTest.status} ${corsTest.statusText}`);
            
            // Show results in a toast
            const summary = results.join(' | ');
            showToast('info', 'API Debug Results', summary, 8000);
            
            // Also log to console
            console.log('üîç API Debug Summary:', summary);
            
          } catch (e) {
            console.error('üîç API connection test failed:', e);
            showToast('error', 'API Debug Failed', `Connection test failed: ${e.message}`, 5000);
          }
        }
        
        // Test actual file upload functionality
        async function testFileUpload() {
          console.log('üß™ Testing actual file upload...');
          
          try {
            // Create a minimal test file (this is just for testing the endpoint)
            const testFile = new File(['test audio content'], 'test.mp3', { type: 'audio/mpeg' });
            
            const formData = new FormData();
            formData.append('file', testFile);
            
            const uploadRes = await fetch(`${API_BASE}/songs/upload`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
              body: formData,
            });
            
            console.log('üß™ Test upload response:', uploadRes.status, uploadRes.statusText);
            
            if (uploadRes.ok) {
              const result = await uploadRes.json();
              console.log('üß™ Upload successful:', result);
              showToast('success', 'Upload Test Passed', 'File upload functionality is working!', 5000);
            } else {
              const errorText = await uploadRes.text();
              console.log('üß™ Upload test failed:', errorText);
              showToast('error', 'Upload Test Failed', `Upload failed: ${uploadRes.status} - ${errorText.substring(0, 100)}`, 5000);
            }
            
          } catch (e) {
            console.error('üß™ Upload test error:', e);
            showToast('error', 'Upload Test Error', `Test failed: ${e.message}`, 5000);
          }
        }
        
        // Test the upload button functionality
        function testUploadButton() {
          console.log('üîò Testing upload button functionality...');
          console.log('üîò selectedFiles:', selectedFiles);
          console.log('üîò selectedFiles.length:', selectedFiles.length);
          
          // Create a test file and add it to selectedFiles
          const testFile = new File(['test content'], 'test.mp3', { type: 'audio/mpeg' });
          selectedFiles = [testFile];
          
          console.log('üîò After adding test file - selectedFiles:', selectedFiles);
          console.log('üîò selectedFiles.length:', selectedFiles.length);
          
          // Update the UI
          displayFileList();
          const uploadBtn = document.getElementById('uploadBtn');
          uploadBtn.disabled = false;
          
          console.log('üîò Upload button disabled:', uploadBtn.disabled);
          
          showToast('info', 'Test File Added', 'Test file added. Try clicking Upload All Files now.', 3000);
        }
        
        // Verify test user exists and get correct ID
        async function verifyTestUser() {
          console.log('üë§ Verifying test user...');
          try {
            const res = await fetch(`${API_BASE}/auth/me`, {
              headers: { Authorization: `Bearer ${authToken}` }
            });
            
            if (res.ok) {
              const userData = await res.json();
              console.log('üë§ Current user:', userData);
              
              // If current user is admin, we can upload as admin (no need for test user)
              if (userData.role === 'admin') {
                console.log('üë§ Admin user detected - can upload directly');
                return userData.id;
              }
            }
            
            // Try to find test user by email
            console.log('üë§ Looking for test user...');
            // Note: This would require an admin endpoint to search users
            // For now, we'll use the hardcoded ID but log it
            
            const testUserId = '5df8c64f-a0df-4089-8fd1-d813cd021b31';
            console.log('üë§ Using hardcoded test user ID:', testUserId);
            return testUserId;
            
          } catch (e) {
            console.error('üë§ Error verifying test user:', e);
            return null;
          }
        }
        
        // Test filesystem permissions and directory creation
        async function testFilesystemPermissions() {
          console.log('üíæ Testing filesystem permissions...');
          
          try {
            const res = await fetch(`${API_BASE}/admin/test-filesystem`, {
              headers: { Authorization: `Bearer ${authToken}` }
            });
            
            console.log('üíæ Filesystem test response:', res.status, res.statusText);
            
            if (res.ok) {
              const results = await res.json();
              console.log('üíæ Filesystem test results:', results);
              
              // Create a detailed summary
              let summary = [];
              summary.push(`Working Directory: ${results.current_working_directory}`);
              summary.push(`Environment: ${results.environment.RAILWAY_ENVIRONMENT || 'Not Railway'}`);
              
              // Check directory tests
              const dirResults = results.directory_tests;
              const failedDirs = Object.keys(dirResults).filter(dir => dirResults[dir].status !== 'SUCCESS');
              const successfulDirs = Object.keys(dirResults).filter(dir => dirResults[dir].status === 'SUCCESS');
              
              summary.push(`Directories: ${successfulDirs.length}‚úÖ ${failedDirs.length}‚ùå`);
              
              // Check file tests
              const fileResults = results.file_tests;
              const failedFiles = Object.keys(fileResults).filter(file => fileResults[file].status !== 'SUCCESS');
              const successfulFiles = Object.keys(fileResults).filter(file => fileResults[file].status === 'SUCCESS');
              
              summary.push(`Files: ${successfulFiles.length}‚úÖ ${failedFiles.length}‚ùå`);
              
              // Check permissions
              const permissions = results.permissions;
              const uploadsPerms = permissions.uploads;
              if (uploadsPerms && uploadsPerms.exists) {
                summary.push(`Uploads dir: R:${uploadsPerms.readable ? '‚úÖ' : '‚ùå'} W:${uploadsPerms.writable ? '‚úÖ' : '‚ùå'}`);
              } else {
                summary.push('Uploads dir: ‚ùå Not found');
              }
              
              const summaryText = summary.join(' | ');
              showToast('info', 'Filesystem Test Results', summaryText, 10000);
              
              // Show detailed results in console
              console.log('üíæ Detailed filesystem results:', results);
              
              // If there are permission errors, show a warning
              if (failedDirs.length > 0 || failedFiles.length > 0) {
                showToast('error', 'Filesystem Issues Detected', 
                  `Found ${failedDirs.length} directory and ${failedFiles.length} file permission errors. This may cause upload issues.`, 
                  8000);
              } else {
                showToast('success', 'Filesystem Test Passed', 
                  'All filesystem operations successful. Upload should work properly.', 
                  5000);
              }
              
            } else {
              const errorText = await res.text();
              console.log('üíæ Filesystem test failed:', errorText);
              showToast('error', 'Filesystem Test Failed', 
                `Test failed: ${res.status} - ${errorText.substring(0, 100)}`, 
                5000);
            }
            
          } catch (e) {
            console.error('üíæ Filesystem test error:', e);
            showToast('error', 'Filesystem Test Error', 
              `Test failed: ${e.message}`, 
              5000);
          }
        }

        // === Initialization ===
        window.onload = async function () {
          logToStorage('Admin panel loading...');
          await checkAuthStatus();
          setupDragAndDrop();
          updateLoggingButton();
        };
    
        // Run API test on page load
        window.addEventListener('load', () => {
          setTimeout(testApiConnection, 1000); // Delay to ensure auth is loaded
        });
    
        // === Utility functions ===
        function togglePassword(fieldId) {
          const field = document.getElementById(fieldId);
          const toggle = field.nextElementSibling;
          if (field.type === 'password') {
            field.type = 'text';
            toggle.textContent = 'üôà';
            toggle.title = 'Hide Password';
          } else {
            field.type = 'password';
            toggle.textContent = 'üëÅÔ∏è';
            toggle.title = 'Show Password';
          }
        }
    
        function setupDragAndDrop() {
          const uploadArea = document.getElementById('uploadArea');
          console.log('Setting up drag and drop for:', uploadArea);
          
          // Add click handler to trigger file input
          uploadArea.addEventListener('click', () => {
            document.getElementById('fileInput').click();
          });
          
          uploadArea.addEventListener('dragover', (e) => {
            console.log('Drag over event');
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });
          uploadArea.addEventListener('dragleave', () => {
            console.log('Drag leave event');
            uploadArea.classList.remove('dragover');
          });
          uploadArea.addEventListener('drop', (e) => {
            console.log('Drop event, files:', e.dataTransfer.files);
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(Array.from(e.dataTransfer.files));
          });
        }
    
        // === Auth & UI toggles ===
        async function checkAuthStatus() {
          logToStorage('Checking auth status...');
          if (authToken) {
            try {
              const res = await fetch(`${API_BASE}/auth/me`, {
                headers: { Authorization: `Bearer ${authToken}` },
              });
              if (res.ok) {
                isAuthenticated = true;
                showDashboard();
                loadStats();
                loadLibrary();
                loadPlaylists();
              } else {
                throw new Error('Invalid token');
              }
            } catch {
              authToken = null;
              localStorage.removeItem('streamflow_admin_token');
              isAuthenticated = false;
              showLogin();
            }
          } else {
            showLogin();
          }
        }
    
        function showDashboard() {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          document.getElementById('logoutBtn').style.display = 'inline-block';
          document.getElementById('debugBtn').style.display = 'inline-block';
          document.getElementById('testUploadBtn').style.display = 'inline-block';
          document.getElementById('testButtonBtn').style.display = 'inline-block';
          document.getElementById('testAdminBtn').style.display = 'inline-block';
          document.getElementById('testFilesystemBtn').style.display = 'inline-block';
        }
    
        function showLogin() {
          document.getElementById('loginSection').classList.remove('hidden');
          document.getElementById('adminDashboard').classList.add('hidden');
          document.getElementById('logoutBtn').style.display = 'none';
          document.getElementById('debugBtn').style.display = 'none';
          document.getElementById('testUploadBtn').style.display = 'none';
          document.getElementById('testButtonBtn').style.display = 'none';
          document.getElementById('testAdminBtn').style.display = 'none';
          document.getElementById('testFilesystemBtn').style.display = 'none';
        }
    
        // === Login / Logout ===
        async function login() {
          const email = document.getElementById('adminEmail').value;
          const password = document.getElementById('adminPassword').value;
          const status = document.getElementById('loginStatus');
          status.innerHTML = 'üîÑ Logging in‚Ä¶';
          try {
            const res = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password }),
            });
            if (res.ok) {
              const data = await res.json();
              authToken = data.access_token;
              localStorage.setItem(
                'streamflow_admin_token',
                authToken
              );
              isAuthenticated = true;
              showDashboard();
              loadStats();
              loadLibrary();
              loadPlaylists();
              status.innerHTML = '‚úÖ Login successful!';
            } else {
              const err = await res.json();
              showError('Login Failed', err.detail || 'Invalid credentials', 5000);
              status.innerHTML = `‚ùå Login failed: ${err.detail}`;
            }
          } catch (e) {
            showError('Login Error', e.message || 'Network error occurred', 5000);
            status.innerHTML = `‚ùå Error: ${e.message}`;
          }
        }
    
        function logout() {
          authToken = null;
          localStorage.removeItem('streamflow_admin_token');
          isAuthenticated = false;
          showLogin();
          document.getElementById('loginStatus').innerHTML = '';
        }
    
        // === File selection & upload ===
        function handleFileSelect(e) {
          handleFiles(Array.from(e.target.files));
        }
    
        function handleFiles(files) {
          console.log('üìÅ handleFiles called with:', files);
          console.log('üìÅ files.length:', files.length);
          selectedFiles = files;
          console.log('üìÅ selectedFiles updated:', selectedFiles);
          console.log('üìÅ selectedFiles.length:', selectedFiles.length);
          displayFileList();
          const uploadBtn = document.getElementById('uploadBtn');
          console.log('üìÅ Upload button before:', uploadBtn.disabled);
          uploadBtn.disabled = files.length === 0;
          console.log('üìÅ Upload button after:', uploadBtn.disabled);
        }
    
        function displayFileList() {
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          selectedFiles.forEach((file, i) => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
              <div>
                <span class="file-name">${file.name}</span>
                <span class="file-size">${formatFileSize(
              file.size
            )}</span>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="progress-${i}"
                  ></div>
                </div>
              </div>
              <button
                class="btn btn-danger btn-small"
                onclick="removeFile(${i})"
              >
                Remove
              </button>
            `;
            fileList.appendChild(div);
          });
        }
    
        function removeFile(idx) {
          selectedFiles.splice(idx, 1);
          displayFileList();
          document.getElementById('uploadBtn').disabled =
            selectedFiles.length === 0;
        }
    
        function clearFiles() {
          selectedFiles = [];
          displayFileList();
          document.getElementById('uploadBtn').disabled = true;
          document.getElementById('fileInput').value = '';
        }
    
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i]
          );
        }
    
        async function uploadFiles() {
          console.log('üöÄ uploadFiles function called');
          console.log('üöÄ selectedFiles:', selectedFiles);
          console.log('üöÄ selectedFiles.length:', selectedFiles.length);
          
          if (!selectedFiles.length) {
            console.log('‚ùå No files selected, returning early');
            showToast('warning', 'No Files Selected', 'Please select files to upload first.', 3000);
            return;
          }
          
          console.log('üöÄ Starting upload process...');
          const btn = document.getElementById('uploadBtn');
          console.log('üöÄ Upload button:', btn);
          btn.disabled = true;
          
          const uploadAsTestUser = document.getElementById('uploadAsTestUser').checked;
          const uploadDestination = document.getElementById('uploadDestination').value;
          const playlistId = document.getElementById('playlistSelect').value;
          const newPlaylistName = document.getElementById('newPlaylistName').value;

          console.log('üöÄ Upload settings:', {
            uploadAsTestUser,
            uploadDestination,
            playlistId,
            newPlaylistName
          });

          // Get the correct test user ID
          let testUserId = null;
          if (uploadAsTestUser) {
            testUserId = await verifyTestUser();
            if (!testUserId) {
              showToast('error', 'Test User Not Found', 'Could not find test user. Please check the test user ID.', 5000);
              btn.disabled = false;
              return;
            }
            console.log('üöÄ Using test user ID:', testUserId);
          }

          // Create new playlist if needed
          let targetPlaylistId = playlistId;
          if (playlistId === 'new' && newPlaylistName.trim()) {
            try {
              const playlistData = {
                name: newPlaylistName.trim(),
                description: `Playlist created during upload - ${new Date().toLocaleDateString()}`
              };
              
              const createRes = await fetch(`${API_BASE}/playlists/`, {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${authToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(playlistData)
              });
              
              if (createRes.ok) {
                const newPlaylist = await createRes.json();
                targetPlaylistId = newPlaylist.id;
                showToast('success', 'Playlist Created', `Created new playlist: "${newPlaylistName}"`, 3000);
              } else {
                throw new Error('Failed to create playlist');
              }
            } catch (e) {
              showToast('error', 'Playlist Creation Failed', 'Unable to create the new playlist. Please try again.', 5000);
              btn.disabled = false;
              return;
            }
          }

          let success = 0, error = 0;
          const totalFiles = selectedFiles.length;
          
          showToast('info', 'Upload Started', `Uploading ${totalFiles} file${totalFiles !== 1 ? 's' : ''}...`, 2000);
          
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const form = new FormData();
            form.append('file', file);
            
            // Add user_id parameter if uploading as test user
            if (uploadAsTestUser) {
              form.append('user_id', testUserId);
              console.log('üöÄ Adding user_id to form:', testUserId);
            }
            
            // Debug: Log form data
            console.log('üöÄ Form data entries:');
            for (let [key, value] of form.entries()) {
              console.log('üöÄ', key, ':', value);
            }
            
            try {
              console.log('üöÄ Making fetch request to:', `${API_BASE}/songs/upload`);
              console.log('üöÄ Request headers:', {
                Authorization: `Bearer ${authToken}`,
                'Content-Type': 'multipart/form-data' // This will be set automatically by browser
              });
              console.log('üöÄ Form data size:', form.get('file').size);
              console.log('üöÄ Form data name:', form.get('file').name);
              
              const res = await fetch(
                `${API_BASE}/songs/upload`,
                {
                  method: 'POST',
                  headers: {
                    Authorization: `Bearer ${authToken}`,
                  },
                  body: form,
                }
              );
              
              console.log('üöÄ Response received:', {
                status: res.status,
                statusText: res.statusText,
                ok: res.ok,
                url: res.url
              });
              
              if (res.ok) {
                const result = await res.json();
                console.log('üöÄ Upload successful:', result);
                success++;
                document.getElementById(
                  `progress-${i}`
                ).style.width = '100%';
                document.getElementById(
                  `progress-${i}`
                ).style.background = '#28a745';
                
                // If uploading to playlist, add to playlist
                if (uploadDestination === 'playlist' && targetPlaylistId) {
                  const songData = await res.json();
                  const playlistSuccess = await addSongToPlaylist(songData.id, targetPlaylistId);
                  if (!playlistSuccess) {
                    console.warn(`Failed to add song ${songData.title} to playlist`);
                  }
                }
              } else {
                error++;
                document.getElementById(
                  `progress-${i}`
                ).style.background = '#dc3545';
                
                // Log detailed error information
                const errorText = await res.text();
                console.error(`üöÄ Upload failed for ${file.name}:`, {
                  status: res.status,
                  statusText: res.statusText,
                  response: errorText,
                  url: `${API_BASE}/songs/upload`,
                  requestHeaders: {
                    Authorization: `Bearer ${authToken}`,
                    'Content-Type': 'multipart/form-data'
                  }
                });
                
                // Show specific error message
                showToast('error', 'Upload Failed', 
                  `Failed to upload ${file.name}: ${res.status} ${res.statusText}`, 3000);
              }
            } catch (e) {
              error++;
              document.getElementById(
                `progress-${i}`
              ).style.background = '#dc3545';
              
              // Log detailed error information
              console.error(`Upload error for ${file.name}:`, {
                error: e.message,
                stack: e.stack,
                url: `${API_BASE}/songs/upload`,
                fileSize: file.size,
                fileName: file.name
              });
              
              // Show specific error message
              showToast('error', 'Upload Error', 
                `Error uploading ${file.name}: ${e.message}`, 3000);
            }
          }

          // Show final results
          if (success > 0) {
            let message = `Successfully uploaded ${success} file${success !== 1 ? 's' : ''}`;
            if (error > 0) {
              message += `, ${error} failed`;
            }
            if (uploadAsTestUser) {
              message += ' (as test user)';
            }
            if (uploadDestination === 'playlist' && targetPlaylistId) {
              if (playlistId === 'new') {
                message += ' and created new playlist';
              } else {
                message += ' and added to playlist';
              }
            }
            
            showToast('success', 'Upload Complete', message, 5000);
            
            loadStats();
            loadLibrary();
            // Don't reload playlists here as it would reset the user's selection
            // Only reload if we created a new playlist to show it in the list
            if (playlistId === 'new' && targetPlaylistId) {
              loadPlaylists(); // Refresh playlists to show the new one
            }
            clearFiles();
          } else {
            showToast('error', 'Upload Failed', 'No files were uploaded successfully. Please try again.', 5000);
          }
          
          btn.disabled = false;
        }
    
        async function addSongToPlaylist(songId, playlistId) {
          try {
            const res = await fetch(`${API_BASE}/playlists/${playlistId}/songs`, {
              method: 'POST',
              headers: { 
                Authorization: `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                song_id: songId
              })
            });
            return res.ok;
          } catch (e) {
            console.error('Error adding to playlist:', e);
            return false;
          }
        }
    
        async function loadPlaylists() {
          try {
            const select = document.getElementById('playlistSelect');
            const currentSelection = select.value; // Store current selection
            
            select.innerHTML = '<option value="">Loading playlists...</option>';
            
            // Fetch all playlists with owner information (admin endpoint)
            const res = await fetch(`${API_BASE}/playlists/admin/all`, {
              headers: { Authorization: `Bearer ${authToken}` }
            });
            
            if (res.ok) {
              const playlists = await res.json();
              select.innerHTML = '<option value="">Select a playlist...</option>';
              select.innerHTML += '<option value="new">‚ûï Create New Playlist</option>';
              
              if (playlists.length === 0) {
                select.innerHTML += '<option value="" disabled>No existing playlists found</option>';
              } else {
                playlists.forEach(p => {
                  // Use owner_id as fallback if owner object is not available
                  const ownerInfo = p.owner ? ` (${p.owner.username})` : ` (User: ${p.owner_id?.substring(0, 8)}...)`;
                  const songCount = p.songs ? p.songs.length : 0;
                  select.innerHTML += `<option value="${p.id}">${p.name}${ownerInfo} - ${songCount} songs</option>`;
                });
              }
              
              // Restore selection if it still exists in the new list
              if (currentSelection && currentSelection !== 'new') {
                // Check if the previously selected playlist still exists
                const playlistExists = playlists.some(p => p.id === currentSelection);
                if (playlistExists) {
                  select.value = currentSelection;
                }
              } else if (currentSelection === 'new') {
                // If "new" was selected, keep it selected
                select.value = 'new';
              }
            } else {
              select.innerHTML = '<option value="">Error loading playlists</option>';
              console.error('Failed to load playlists:', res.status);
            }
          } catch (e) {
            console.error('Error loading playlists:', e);
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Error loading playlists</option>';
          }
        }
    
        async function refreshPlaylists() {
          const refreshBtn = document.querySelector('button[onclick="refreshPlaylists()"]');
          const originalText = refreshBtn.textContent;
          refreshBtn.textContent = 'üîÑ Loading...';
          refreshBtn.disabled = true;
          
          try {
            await loadPlaylists();
            refreshBtn.textContent = '‚úÖ Refreshed!';
            setTimeout(() => {
              refreshBtn.textContent = originalText;
              refreshBtn.disabled = false;
            }, 1000);
          } catch (e) {
            refreshBtn.textContent = '‚ùå Error';
            setTimeout(() => {
              refreshBtn.textContent = originalText;
              refreshBtn.disabled = false;
            }, 2000);
          }
        }
    
        // === Stats & library ===
        async function loadStats() {
          try {
            const [sR, pR, uR] = await Promise.all([
              fetch(`${API_BASE}/songs/`, {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
              }),
              fetch(`${API_BASE}/playlists/`, {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
              }),
              fetch(`${API_BASE}/auth/me`, {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
              }),
            ]);
            if (sR.ok) {
              const songs = await sR.json();
              document.getElementById('totalSongs').textContent =
                songs.length;
            }
            if (pR.ok) {
              const pls = await pR.json();
              document.getElementById(
                'totalPlaylists'
              ).textContent = pls.length;
            }
            if (uR.ok) {
              const user = await uR.json();
              document.getElementById('totalUsers').textContent =
                '2';
              document.getElementById(
                'headerSubtitle'
              ).innerHTML = `Manage your music library<br><small>Logged in as: ${user.username}</small>`;
            }
          } catch (e) {
            console.error('Error loading stats:', e);
          }
        }
    
        async function loadLibrary() {
          // Don't load all songs initially - only load on search
          const grid = document.getElementById('libraryGrid');
          grid.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px;">üîç Search for songs to display them here</div>';
        }

        // Debounced search function
        let searchTimeout;
        async function searchLibrary() {
          const searchInput = document.getElementById('searchLibrary');
          const searchStatus = document.getElementById('searchStatus');
          const term = searchInput.value.trim();
          
          // Clear previous timeout
          clearTimeout(searchTimeout);
          
          if (term.length === 0) {
            searchStatus.textContent = '';
            const grid = document.getElementById('libraryGrid');
            grid.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px;">üîç Search for songs to display them here</div>';
            return;
          }
          
          // Show searching status
          searchStatus.textContent = 'üîç Searching...';
          
          // Debounce the search
          searchTimeout = setTimeout(async () => {
            try {
              const res = await fetch(`${API_BASE}/songs/?search=${encodeURIComponent(term)}`, {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
              });
              
              if (res.ok) {
                const songs = await res.json();
                displayLibrary(songs, term);
                searchStatus.textContent = `Found ${songs.length} song${songs.length !== 1 ? 's' : ''}`;
              } else {
                searchStatus.textContent = '‚ùå Search failed';
                console.error('Search failed:', res.status);
              }
            } catch (e) {
              searchStatus.textContent = '‚ùå Search error';
              console.error('Search error:', e);
            }
          }, 300); // 300ms debounce
        }

        function displayLibrary(songs, searchTerm = '') {
          const grid = document.getElementById('libraryGrid');
          
          if (songs.length === 0) {
            grid.innerHTML = `<div style="text-align: center; color: #6c757d; padding: 40px;">
              üîç No songs found for "${searchTerm}"
            </div>`;
            return;
          }
          
          grid.innerHTML = '';
          songs.forEach((s) => {
            const card = document.createElement('div');
            card.className = 'song-card';
            card.onclick = () => toggleCardExpansion(card);
            
            card.innerHTML = `
              <div class="expand-indicator">‚ñº</div>
              <div class="song-title">${s.title}</div>
              <div class="song-artist">${s.artist}</div>
              <div class="song-meta">
                ${s.album ? `Album: ${s.album}<br>` : ''}
                ${s.genre ? `Genre: ${s.genre}<br>` : ''}
                Duration: ${formatDuration(s.duration)}<br>
                Size: ${formatFileSize(s.file_size)}
              </div>
              <div class="song-actions">
                <button class="btn btn-secondary btn-small" onclick="deleteSong('${s.id}', event)">Delete</button>
              </div>
            `;
            grid.appendChild(card);
          });
        }

        function toggleCardExpansion(card) {
          card.classList.toggle('expanded');
        }

        function formatDuration(sec) {
          if (!sec) return 'Unknown';
          const m = Math.floor(sec / 60);
          const s = String(sec % 60).padStart(2, '0');
          return `${m}:${s}`;
        }

        async function deleteSong(id, event) {
          // Prevent card expansion when clicking delete button
          if (event) {
            event.stopPropagation();
          }
          
          // Store the song info for potential undo
          let deletedSongInfo = null;
          
          try {
            // Get song info before deletion for undo functionality
            const songRes = await fetch(`${API_BASE}/songs/${id}`, {
              headers: { Authorization: `Bearer ${authToken}` }
            });
            if (songRes.ok) {
              deletedSongInfo = await songRes.json();
            }
            
            const res = await fetch(`${API_BASE}/songs/${id}`, {
              method: 'DELETE',
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            });
            if (res.ok) {
              // Store deleted song info for undo (with timestamp)
              if (deletedSongInfo) {
                deletedSongs.push({
                  ...deletedSongInfo,
                  deletedAt: new Date().toISOString(),
                  originalId: id
                });
                
                // Keep only last 10 deleted songs
                if (deletedSongs.length > 10) {
                  deletedSongs = deletedSongs.slice(-10);
                }
                
                showToast('success', 'Song Deleted', 
                  `"${deletedSongInfo.title}" has been removed. <button onclick="undoDeleteSong('${id}', '${deletedSongInfo.title}', '${deletedSongInfo.artist}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-left: 8px; cursor: pointer; font-size: 12px;">Undo</button>`, 
                  8000);
              }
              
              loadStats();
              // Refresh the current search results
              const searchInput = document.getElementById('searchLibrary');
              if (searchInput.value.trim()) {
                searchLibrary();
              }
            } else {
              showError('Delete Failed', 'Unable to delete the song. Please try again.', 5000);
            }
          } catch (e) {
            console.error('Delete error:', e);
            showError('Delete Error', 'An error occurred while deleting the song. Please try again.', 5000);
          }
        }
        
        async function undoDeleteSong(songId, title, artist) {
          // Find the deleted song in our storage
          const deletedSong = deletedSongs.find(song => song.originalId === songId);
          
          if (deletedSong) {
            showInfo('Undo Not Available', 
              `To restore "${title}" by ${artist}, please re-upload the audio file. The file has been permanently removed from storage.`, 
              6000);
            
            // Remove from deleted songs storage
            deletedSongs = deletedSongs.filter(song => song.originalId !== songId);
          } else {
            showWarning('Song Not Found', 
              `The deleted song information is no longer available for undo.`, 
              4000);
          }
        }

        // === Cleanup ===
        async function runCleanup(mode) {
          logToStorage('runCleanup start', mode);
          const dryBtn = document.getElementById('dryRunBtn');
          const fullBtn = document.getElementById('fullCleanupBtn');
          const prog = document.getElementById('cleanupProgress');
          const resD = document.getElementById('cleanupResults');
          const bar = document.getElementById('cleanupProgressBar');
          const status = document.getElementById('cleanupStatus');
          dryBtn.disabled = true;
          fullBtn.disabled = true;
          prog.style.display = 'block';
          resD.style.display = 'none';
          bar.style.width = '0%';
          status.textContent = 'Initializing cleanup‚Ä¶';
    
          try {
            // simulate steps‚Ä¶
            for (let pct of [20, 40, 60, 80, 100]) {
              await new Promise((r) => setTimeout(r, 300));
              bar.style.width = `${pct}%`;
              status.textContent = `Progress: ${pct}%`;
            }
    
            const resp = await fetch(`${API_BASE}/admin/cleanup`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${authToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                mode,
                dry_run: mode === 'dry-run',
              }),
            });
            if (resp.ok) {
              const result = await resp.json();
              displayCleanupResults(result, mode);
            } else {
              throw new Error('Cleanup API failed');
            }
          } catch (e) {
            status.textContent = `Error: ${e.message}`;
            bar.style.background = '#dc3545';
          } finally {
            dryBtn.disabled = false;
            fullBtn.disabled = false;
            logToStorage('runCleanup end');
          }
        }
    
        function displayCleanupResults(result, mode) {
          // ‚Ä¶ handle summary & details ‚Ä¶
          document.getElementById('cleanupResults').style.display = 'block';
          document.getElementById('clearResultsBtn').style.display =
            'inline-block';
        }
    
        function clearCleanupResults() {
          document.getElementById('cleanupProgress').style.display = 'none';
          document.getElementById('cleanupResults').style.display = 'none';
          document.getElementById('clearResultsBtn').style.display = 'none';
          document.getElementById('cleanupProgressBar').style.width = '0%';
          document.getElementById(
            'cleanupProgressBar'
          ).style.background = 'linear-gradient(90deg, #667eea, #764ba2)';
        }
    
        // Ctrl+Shift+L => logs
        document.addEventListener('keydown', function (e) {
          if (e.ctrlKey && e.shiftKey && e.key === 'L') {
            e.preventDefault();
            showLogs();
          }
        });

        function updateUploadButtonText() {
            const uploadBtn = document.getElementById('uploadBtn');
            const testUserIndicator = document.getElementById('testUserIndicator');
            const playlistGroup = document.getElementById('playlistSelectionGroup');
            const newPlaylistGroup = document.getElementById('newPlaylistGroup');
            const uploadAsTestUser = document.getElementById('uploadAsTestUser').checked;
            const uploadDestination = document.getElementById('uploadDestination').value;
            const playlistSelect = document.getElementById('playlistSelect');
            
            let buttonText = 'Upload All Files';
            if (uploadAsTestUser) buttonText += ' (as Test User)';
            if (uploadDestination === 'playlist') buttonText = 'Upload & Add to Playlist';
            
            uploadBtn.textContent = buttonText;
            testUserIndicator.style.display = uploadAsTestUser ? 'block' : 'none';
            playlistGroup.style.display = uploadDestination === 'playlist' ? 'block' : 'none';
            
            // Show/hide new playlist input based on selection
            if (uploadDestination === 'playlist' && playlistSelect.value === 'new') {
                newPlaylistGroup.style.display = 'block';
                buttonText = 'Upload & Create New Playlist';
                document.getElementById('selectedPlaylistIndicator').style.display = 'none';
            } else if (uploadDestination === 'playlist' && playlistSelect.value) {
                newPlaylistGroup.style.display = 'none';
                // Show selected playlist indicator
                const indicator = document.getElementById('selectedPlaylistIndicator');
                const nameSpan = document.getElementById('selectedPlaylistName');
                const selectedOption = playlistSelect.options[playlistSelect.selectedIndex];
                nameSpan.textContent = selectedOption.text;
                indicator.style.display = 'block';
            } else {
                newPlaylistGroup.style.display = 'none';
                document.getElementById('selectedPlaylistIndicator').style.display = 'none';
            }
            
            uploadBtn.textContent = buttonText;
            
            // Load playlists if playlist mode is selected and no playlists are loaded yet
            if (uploadDestination === 'playlist') {
                const playlistSelect = document.getElementById('playlistSelect');
                if (playlistSelect.options.length <= 1) { // Only "Loading playlists..." or empty
                    loadPlaylists();
                }
            }
        }

        // === Toast Notification System ===
        function showToast(type, title, message, duration = 5000) {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        // Convenience functions
        function showSuccess(title, message, duration) {
            showToast('success', title, message, duration);
        }
        
        function showError(title, message, duration) {
            showToast('error', title, message, duration);
        }
        
        function showWarning(title, message, duration) {
            showToast('warning', title, message, duration);
        }
        
        function showInfo(title, message, duration) {
            showToast('info', title, message, duration);
        }

        // Test upload as current admin user (not test user)
        async function testAdminUpload() {
          console.log('üëë Testing admin upload...');
          
          try {
            // Create a minimal test file
            const testFile = new File(['test admin content'], 'admin_test.mp3', { type: 'audio/mpeg' });
            
            const formData = new FormData();
            formData.append('file', testFile);
            // Don't add user_id - let it upload to current admin user
            
            console.log('üëë Form data entries:');
            for (let [key, value] of formData.entries()) {
              console.log('üëë', key, ':', value);
            }
            
            const uploadRes = await fetch(`${API_BASE}/songs/upload`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
              body: formData,
            });
            
            console.log('üëë Admin upload response:', uploadRes.status, uploadRes.statusText);
            
            if (uploadRes.ok) {
              const result = await uploadRes.json();
              console.log('üëë Admin upload successful:', result);
              showToast('success', 'Admin Upload Test Passed', 'Upload as admin user is working!', 5000);
            } else {
              const errorText = await uploadRes.text();
              console.log('üëë Admin upload test failed:', errorText);
              showToast('error', 'Admin Upload Test Failed', `Upload failed: ${uploadRes.status} - ${errorText.substring(0, 100)}`, 5000);
            }
            
          } catch (e) {
            console.error('üëë Admin upload test error:', e);
            showToast('error', 'Admin Upload Test Error', `Test failed: ${e.message}`, 5000);
          }
        }
    </script>
</body>
</html> 